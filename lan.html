<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Vector Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
        }
        canvas {
            background-color: #2c2c2c;
            display: block;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        #lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background: rgba(26, 26, 26, 0.95);
            padding: 40px;
            border-radius: 10px;
        }
        #lobby h1 {
            margin-top: 0;
        }
        #lobby input {
            padding: 10px;
            font-size: 1em;
            margin: 10px;
            border-radius: 5px;
            border: none;
            width: 250px;
            text-align: center;
            background-color: #333;
            color: #fff;
        }
        #lobby button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px;
            border: none;
            background: #0074d9;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #lobby button:hover {
            background: #0062b3;
        }
        #gameInfo {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        #gameInfo span {
            font-weight: bold;
            color: #ffdc00;
        }
    </style>
</head>
<body>
    <div id="lobby">
        <h1>Vector LAN Game</h1>
        <p>Enter a Game ID to join or create a game.</p>
        <input type="text" id="gameIdInput" placeholder="Enter Game ID">
        <button id="joinGameBtn">Join Game</button>
    </div>

    <canvas id="gameCanvas" style="display: none;"></canvas>
    <div id="gameInfo">
        <p>Game ID: <span id="gameIdDisplay"></span></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- UI Elements ---
        const lobbyDiv = document.getElementById('lobby');
        const gameIdInput = document.getElementById('gameIdInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const gameInfoDiv = document.getElementById('gameInfo');
        const gameIdDisplay = document.getElementById('gameIdDisplay');

        // --- Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let app, auth, db;
        let userId;
        let gameId;
        let unsubscribePlayerListener = null;

        // --- Game State ---
        const players = {}; // Use an object to store players by ID
        const PLAYER_COLORS = ['#ff4136', '#0074d9', '#2ecc40', '#ffdc00', '#f012be', '#ff851b'];

        // --- Game Settings ---
        const PLAYER_SIZE = 20;
        const PLAYER_SPEED = 0.8;
        const FRICTION = 0.9;

        // --- Input Handling ---
        const keys = {};
        window.addEventListener('keydown', (e) => { keys[e.key.toLowerCase()] = true; });
        window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });

        // --- Canvas Sizing ---
        function resizeCanvas() {
            const size = Math.min(window.innerWidth * 0.9, window.innerHeight * 0.9);
            canvas.width = size;
            canvas.height = size;
        }
        window.addEventListener('resize', resizeCanvas);


        // --- Player Class ---
        class Player {
            constructor(id, x, y, color, isLocal = false) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.size = PLAYER_SIZE;
                this.color = color;
                this.vx = 0;
                this.vy = 0;
                this.isLocal = isLocal;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();

                let angle = Math.atan2(this.vy, this.vx);
                if (this.vx === 0 && this.vy === 0) {
                  angle = -Math.PI / 2;
                }
                const eyeX = this.x + Math.cos(angle) * this.size * 0.6;
                const eyeY = this.y + Math.sin(angle) * this.size * 0.6;
                ctx.beginPath();
                ctx.arc(eyeX, eyeY, this.size * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(eyeX, eyeY, this.size * 0.15, 0, Math.PI * 2);
                ctx.fillStyle = 'black';
                ctx.fill();
            }

            // This update is only for the local player based on keyboard input
            updateLocal() {
                if (!this.isLocal) return;

                if (keys['w'] || keys['arrowup']) this.vy -= PLAYER_SPEED;
                if (keys['s'] || keys['arrowdown']) this.vy += PLAYER_SPEED;
                if (keys['a'] || keys['arrowleft']) this.vx -= PLAYER_SPEED;
                if (keys['d'] || keys['arrowright']) this.vx += PLAYER_SPEED;

                this.x += this.vx;
                this.y += this.vy;
                this.vx *= FRICTION;
                this.vy *= FRICTION;

                // Boundary collision
                if (this.x - this.size < 0) { this.x = this.size; this.vx *= -0.5; }
                if (this.x + this.size > canvas.width) { this.x = canvas.width - this.size; this.vx *= -0.5; }
                if (this.y - this.size < 0) { this.y = this.size; this.vy *= -0.5; }
                if (this.y + this.size > canvas.height) { this.y = canvas.height - this.size; this.vy *= -0.5; }
            }

            // Update player state from Firestore data
            updateFromState(state) {
                 if (this.isLocal) return; // Don't snap local player
                 this.x = state.x;
                 this.y = state.y;
                 this.vx = state.vx;
                 this.vy = state.vy;
            }
        }


        async function joinGame() {
            gameId = gameIdInput.value.trim();
            if (!gameId) {
                alert("Please enter a Game ID.");
                return;
            }

            lobbyDiv.style.display = 'none';
            canvas.style.display = 'block';
            gameInfoDiv.style.display = 'block';
            gameIdDisplay.innerText = gameId;

            resizeCanvas();

            const gameCollectionPath = `/artifacts/${appId}/public/data/lan-game/${gameId}/players`;
            const playersCollection = collection(db, gameCollectionPath);

            // Determine player color
            const playersSnapshot = await getDocs(playersCollection);
            const playerCount = playersSnapshot.size;
            const playerColor = PLAYER_COLORS[playerCount % PLAYER_COLORS.length];

            // Create our player instance
            const startX = Math.random() * (canvas.width - 100) + 50;
            const startY = Math.random() * (canvas.height - 100) + 50;
            players[userId] = new Player(userId, startX, startY, playerColor, true);

            // Listen for changes to all players in the game
            unsubscribePlayerListener = onSnapshot(playersCollection, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const playerData = change.doc.data();
                    const playerId = change.doc.id;

                    if (change.type === "added") {
                        if (playerId !== userId) {
                            players[playerId] = new Player(playerId, playerData.x, playerData.y, playerData.color);
                        }
                    }
                    if (change.type === "modified") {
                        if (players[playerId]) {
                           players[playerId].updateFromState(playerData);
                        }
                    }
                    if (change.type === "removed") {
                        delete players[playerId];
                    }
                });
            });

            // Start the game loop
            gameLoop();
        }

        function updatePlayerInFirestore() {
            const localPlayer = players[userId];
            if (!localPlayer) return;

            const playerDocRef = doc(db, `/artifacts/${appId}/public/data/lan-game/${gameId}/players/${userId}`);
            setDoc(playerDocRef, {
                x: localPlayer.x,
                y: localPlayer.y,
                vx: localPlayer.vx,
                vy: localPlayer.vy,
                color: localPlayer.color
            }, { merge: true });
        }


        // --- Game Loop ---
        function gameLoop() {
            ctx.fillStyle = 'rgba(44, 44, 44, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const localPlayer = players[userId];
            if (localPlayer) {
                localPlayer.updateLocal();
                updatePlayerInFirestore();
            }
            
            for (const id in players) {
                players[id].draw();
            }

            requestAnimationFrame(gameLoop);
        }

        async function init() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('debug'); // Uncomment for detailed logs

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with user ID:", userId);
                        joinGameBtn.disabled = false;
                    }
                });
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                   await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                   await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                lobbyDiv.innerHTML = "<h1>Error</h1><p>Could not connect to the game service. Please try again later.</p>";
            }
        }
        
        // --- Event Listeners ---
        joinGameBtn.addEventListener('click', joinGame);
        gameIdInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') joinGame();
        });

        window.addEventListener('beforeunload', () => {
            if (userId && gameId) {
                const playerDocRef = doc(db, `/artifacts/${appId}/public/data/lan-game/${gameId}/players/${userId}`);
                deleteDoc(playerDocRef);
            }
            if (unsubscribePlayerListener) {
                unsubscribePlayerListener();
            }
        });

        init();
    </script>
</body>
</html>

