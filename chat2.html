<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Chat Environment (Optimized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrollbars from appearing */
        }
        canvas {
            background-color: #1a202c; /* dark gray */
            display: block;
        }
        /* Custom styles for the color input */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 44px;
            height: 44px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 50%;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 2px solid #4A5568;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen">

    <!-- Username Modal -->
    <div id="username-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-8 max-w-sm w-full text-center shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Welcome!</h2>
            <p class="text-gray-400 mb-6">Please enter a username to continue.</p>
            <input type="text" id="username-input" placeholder="Your Name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" maxlength="20">
            <button id="set-username-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition">Start Chatting</button>
            <p id="username-error" class="text-red-400 text-center mt-4 hidden"></p>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-8 max-w-2xl w-full text-left shadow-xl">
            <h2 class="text-2xl font-bold mb-6 text-center">Command List</h2>
            <ul class="space-y-4 text-gray-300">
                <li><code class="bg-gray-700 rounded px-2 py-1 font-mono">/user "name"</code> - Changes your username.</li>
                <li><code class="bg-gray-700 rounded px-2 py-1 font-mono">/shape "shape"</code> - Changes your shape. Options: circle, square, triangle.</li>
                <li><code class="bg-gray-700 rounded px-2 py-1 font-mono">/color "#hex"</code> - Changes your shape's color (e.g., "#FF0000").</li>
                <li><code class="bg-gray-700 rounded px-2 py-1 font-mono">/avatar "text" "#hex"</code> - Sets avatar text and optional color.</li>
                <li><code class="bg-gray-700 rounded px-2 py-1 font-mono">/avatarangle "deg"</code> - Rotates your avatar text.</li>
                <li><code class="bg-gray-700 rounded px-2 py-1 font-mono">/cosmetic "name"</code> - Equips a cosmetic. Options: crown, tophat, cap, none.</li>
            </ul>
            <div class="text-center mt-8">
                <button id="close-help-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app" class="hidden w-full h-full bg-gray-800 flex flex-col">

        <!-- Lobby Selection / Creation -->
        <div id="lobby-view" class="flex flex-col items-center justify-center h-full p-4">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-6xl mx-auto items-center">
                <!-- Left Column: Customization -->
                <div id="customization-view" class="bg-gray-900 p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 text-center">Customize Your Character</h2>
                    <canvas id="preview-canvas" width="200" height="200" class="mx-auto bg-gray-800 rounded-lg mb-6"></canvas>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                           <div>
                               <label for="username-edit" class="block text-sm font-medium text-gray-400 mb-1">Username</label>
                               <input type="text" id="username-edit" class="w-full bg-gray-700 rounded p-2">
                           </div>
                           <div>
                               <label for="shape-select" class="block text-sm font-medium text-gray-400 mb-1">Shape</label>
                               <select id="shape-select" class="w-full bg-gray-700 rounded p-2">
                                   <option>circle</option>
                                   <option>square</option>
                                   <option>triangle</option>
                               </select>
                           </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                           <div>
                               <label class="block text-sm font-medium text-gray-400 mb-1">Color</label>
                               <input type="color" id="color-picker" class="w-full">
                           </div>
                           <div>
                                <label for="cosmetic-select" class="block text-sm font-medium text-gray-400 mb-1">Cosmetic</label>
                               <select id="cosmetic-select" class="w-full bg-gray-700 rounded p-2">
                                   <option value="">none</option>
                                   <option>crown</option>
                                   <option>tophat</option>
                                   <option>cap</option>
                               </select>
                           </div>
                        </div>
                         <div>
                           <label class="block text-sm font-medium text-gray-400 mb-1">Avatar</label>
                            <div class="grid grid-cols-3 gap-2">
                               <input type="text" id="avatar-text" placeholder="Text" class="col-span-2 bg-gray-700 rounded p-2">
                               <input type="color" id="avatar-color-picker">
                           </div>
                       </div>
                        <div>
                           <label for="avatar-angle" class="block text-sm font-medium text-gray-400 mb-1">Avatar Angle (<span id="angle-value">0</span>Â°)</label>
                           <input type="range" id="avatar-angle" min="0" max="360" value="0" class="w-full">
                       </div>
                    </div>
                </div>

                <!-- Right Column: Lobby -->
                <div id="lobby-actions" class="text-center">
                     <h1 class="text-4xl font-bold mb-2 text-center">2D Chat Lobbies</h1>
                     <p class="text-lg text-gray-400 mb-8">Welcome, <span id="welcome-username" class="font-bold text-indigo-400"></span></p>
                     <div class="w-full max-w-sm mx-auto">
                        <button id="create-lobby-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105">
                            Create New Lobby
                        </button>
                        <div class="my-6 flex items-center">
                            <hr class="w-full border-gray-600">
                            <span class="p-2 text-gray-400">OR</span>
                            <hr class="w-full border-gray-600">
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="room-code-input" placeholder="Enter Room Code" class="flex-grow bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="join-lobby-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out">
                                Join Lobby
                            </button>
                        </div>
                         <p id="error-message" class="text-red-400 text-center mt-4 hidden"></p>
                     </div>
                </div>
            </div>
             <div class="fixed bottom-4 left-4 text-xs text-gray-500 font-mono">v3.4</div>
        </div>

        <!-- Chat View (Canvas) -->
        <div id="chat-view" class="hidden flex-grow flex-col w-full h-full">
            <canvas id="game-canvas" class="flex-grow"></canvas>
            <div class="flex-shrink-0 p-4 bg-gray-800 border-t border-gray-700 flex items-center gap-4">
                 <button id="leave-lobby-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    Leave
                </button>
                <input id="message-input" placeholder="Type /help for commands" class="flex-grow bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="text-sm text-gray-400">Room: <span id="room-code-display" class="font-mono cursor-pointer" title="Click to copy"></span></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        let userFirebaseConfig = {
            apiKey: "AIzaSyAflXtpfodNrcyLzYBGoXVdTlaUYcxSNn0",
            authDomain: "chat-app-7c620.firebaseapp.com",
            projectId: "chat-app-7c620",
            storageBucket: "chat-app-7c620.appspot.com",
            messagingSenderId: "300905208973",
            appId: "1:300905208973:web:ac1f41de55a1bb235556c4"
        };
        
        // --- Firebase Services (will be initialized later) ---
        let app, auth, db;

        // --- DOM Elements ---
        const appContainer = document.getElementById('app');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const setUsernameBtn = document.getElementById('set-username-btn');
        const usernameError = document.getElementById('username-error');
        const welcomeUsername = document.getElementById('welcome-username');
        const helpModal = document.getElementById('help-modal');
        const closeHelpBtn = document.getElementById('close-help-btn');

        const lobbyView = document.getElementById('lobby-view');
        const chatView = document.getElementById('chat-view');
        const createLobbyBtn = document.getElementById('create-lobby-btn');
        const joinLobbyBtn = document.getElementById('join-lobby-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const messageInput = document.getElementById('message-input');
        const roomCodeInput = document.getElementById('room-code-input');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const errorMessage = document.getElementById('error-message');
        
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('preview-canvas');
        const previewCtx = previewCanvas.getContext('2d');

        // Customization UI Elements
        const usernameEdit = document.getElementById('username-edit');
        const shapeSelect = document.getElementById('shape-select');
        const colorPicker = document.getElementById('color-picker');
        const cosmeticSelect = document.getElementById('cosmetic-select');
        const avatarText = document.getElementById('avatar-text');
        const avatarColorPicker = document.getElementById('avatar-color-picker');
        const avatarAngle = document.getElementById('avatar-angle');
        const angleValue = document.getElementById('angle-value');

        // --- Asset Management ---
        const cosmeticAssets = {
            crown: { src: 'https://em-content.zobj.net/source/microsoft-teams/363/crown_1f451.png', img: new Image(), loaded: false },
            tophat: { src: 'https://em-content.zobj.net/source/microsoft-teams/363/top-hat_1f3a9.png', img: new Image(), loaded: false },
            cap: { src: 'https://em-content.zobj.net/source/microsoft-teams/363/billed-cap_1f9e2.png', img: new Image(), loaded: false }
        };

        function loadAssets() {
            let assetsToLoad = Object.keys(cosmeticAssets).length;
            if (assetsToLoad === 0) {
                main(); 
                return;
            }
            let assetsLoaded = 0;
            
            for (const key in cosmeticAssets) {
                cosmeticAssets[key].img.src = cosmeticAssets[key].src;
                cosmeticAssets[key].img.onload = () => {
                    cosmeticAssets[key].loaded = true;
                    assetsLoaded++;
                    if (assetsLoaded === assetsToLoad) {
                        main(); 
                    }
                };
                cosmeticAssets[key].img.onerror = () => {
                    console.error(`Failed to load asset: ${key}`);
                    assetsLoaded++; 
                    if (assetsLoaded === assetsToLoad) {
                        main();
                    }
                };
            }
        }


        // --- App State ---
        let currentUserId = null;
        let currentUsername = null;
        let currentLobbyId = null;
        let players = {}; 
        let playerSettings = {};
        let unsubPlayers = null;
        let animationFrameId;
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 100; // ms
        let isTyping = false;

        const keys = { w: false, a: false, s: false, d: false, ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false };

        // --- App Initialization Flow ---

        function main() {
            loadPlayerSettings();
            currentUsername = playerSettings.username;
            if (currentUsername) {
                startApp();
            } else {
                usernameModal.classList.remove('hidden');
                usernameInput.focus();
            }
        }

        function startApp() {
            welcomeUsername.textContent = currentUsername;
            usernameModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            updateCustomizationUI();
            drawPreview();

            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
                if (Object.keys(firebaseConfig).length < 5 && typeof __firebase_config === 'undefined') {
                    throw new Error("Firebase config is incomplete.");
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showError("Firebase config is invalid. Please paste your config and refresh.");
                createLobbyBtn.disabled = true;
                joinLobbyBtn.disabled = true;
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        showError("Authentication failed. Check Firebase config and rules.");
                        createLobbyBtn.disabled = true;
                        joinLobbyBtn.disabled = true;
                    }
                }
            });
        }

        // --- Game Loop and Drawing ---

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }

        function gameLoop(timestamp) {
            updatePlayerPositions();
            draw(timestamp);
            
            if (timestamp - lastUpdateTime > UPDATE_INTERVAL) {
                updateSelfInFirestore();
                lastUpdateTime = timestamp;
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function draw(timestamp) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const id in players) {
                const player = players[id];
                drawPlayer(ctx, player, timestamp);
            }
        }
        
        function drawPlayer(context, player, timestamp) {
            // Draw player shape
            context.fillStyle = player.color;
            context.beginPath();
            switch(player.shape) {
                case 'square':
                    context.rect(player.x - 20, player.y - 20, 40, 40);
                    break;
                case 'triangle':
                    const sideLength = 40;
                    const height = sideLength * (Math.sqrt(3) / 2);
                    context.moveTo(player.x, player.y - height / 2);
                    context.lineTo(player.x - sideLength / 2, player.y + height / 2);
                    context.lineTo(player.x + sideLength / 2, player.y + height / 2);
                    context.closePath();
                    break;
                case 'circle':
                default:
                    context.arc(player.x, player.y, 20, 0, Math.PI * 2);
                    break;
            }
            context.fill();

            // Draw avatar text if it exists
            if (player.avatar) {
                context.save();
                context.translate(player.x, player.y);
                const angleInRadians = (player.avatarAngle || 0) * Math.PI / 180;
                context.rotate(angleInRadians);
                
                context.fillStyle = player.avatarColor || '#FFFFFF';
                context.font = 'bold 16px Inter';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(player.avatar, 0, 0);
                context.restore();
            }

            // Draw cosmetic
            if (player.cosmetic && cosmeticAssets[player.cosmetic]?.loaded) {
                drawCosmetic(context, player.x, player.y, player.cosmetic);
            }

            // Draw username
            context.fillStyle = 'white';
            context.font = '12px Inter';
            context.textAlign = 'center';
            context.textBaseline = 'alphabetic';
            context.fillText(player.username, player.x, player.y + 35);
            
            if (player.message && Date.now() - player.messageTimestamp < 5000) {
                drawChatBubble(context, player.x, player.y - 30, player.message);
            } else if (player.isTyping) {
                drawTypingIndicator(context, player.x, player.y - 30, timestamp);
            }
        }

        function drawPreview() {
            const previewPlayer = {
                ...playerSettings,
                x: previewCanvas.width / 2,
                y: previewCanvas.height / 2,
            };
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            drawPlayer(previewCtx, previewPlayer, performance.now());
        }
        
        function drawCosmetic(ctx, x, y, cosmeticType) {
            const asset = cosmeticAssets[cosmeticType];
            if (!asset || !asset.loaded) return;

            const img = asset.img;
            const width = 50; 
            const height = (img.height / img.width) * width;
            
            ctx.drawImage(img, x - width / 2, y - 25 - height, width, height);
        }

        function drawChatBubble(ctx, x, y, text) {
            const padding = 10;
            ctx.font = '14px Inter';
            const textWidth = ctx.measureText(text).width;
            const bubbleWidth = textWidth + (padding * 2);
            const bubbleHeight = 20 + (padding * 2);
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.roundRect(x - bubbleWidth / 2, y - bubbleHeight, bubbleWidth, bubbleHeight, 10);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y - bubbleHeight / 2 + 5);
        }

        function drawTypingIndicator(ctx, x, y, timestamp) {
            const bubbleWidth = 60;
            const bubbleHeight = 40;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.roundRect(x - bubbleWidth / 2, y - bubbleHeight, bubbleWidth, bubbleHeight, 10);
            ctx.fill();
            ctx.stroke();

            const dotRadius = 4;
            const dotY = y - bubbleHeight / 2;
            const speed = 0.005;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                const alpha = (Math.sin(timestamp * speed + i * 2) + 1) / 2;
                ctx.fillStyle = `rgba(0, 0, 0, ${alpha})`;
                ctx.arc(x - 15 + i * 15, dotY, dotRadius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function updatePlayerPositions() {
            const self = players[currentUserId];
            if (!self || isTyping) return;

            const speed = 3;
            if (keys.w || keys.ArrowUp) { self.y -= speed; }
            if (keys.s || keys.ArrowDown) { self.y += speed; }
            if (keys.a || keys.ArrowLeft) { self.x -= speed; }
            if (keys.d || keys.ArrowRight) { self.x += speed; }
            
            self.x = Math.max(20, Math.min(canvas.width - 20, self.x));
            self.y = Math.max(20, Math.min(canvas.height - 20, self.y));

            for (const id in players) {
                if (id === currentUserId) continue;
                const player = players[id];
                player.x += (player.targetX - player.x) * 0.1;
                player.y += (player.targetY - player.y) * 0.1;
            }
        }

        // --- Lobby and Firestore Logic ---
        
        async function updateSelfInFirestore(data = {}) {
             if (!currentLobbyId || !currentUserId || !players[currentUserId]) return;
             const playerRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies/${currentLobbyId}/players`, currentUserId);
             const updates = {
                x: players[currentUserId].x,
                y: players[currentUserId].y,
                ...data
             };
             await updateDoc(playerRef, updates).catch(console.error);
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function createLobby() {
            if (!currentUserId) return showError("Not authenticated.");
            createLobbyBtn.disabled = true;
            const roomCode = generateRoomCode();
            try {
                const lobbyRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies`, roomCode);
                await setDoc(lobbyRef, { createdAt: serverTimestamp() });
                await joinLobby(roomCode);
            } catch (error) {
                console.error("Error creating lobby:", error);
                showError("Could not create lobby.");
            } finally {
                createLobbyBtn.disabled = false;
            }
        }
        
        async function joinLobby(code) {
            const roomCode = (code || roomCodeInput.value).trim().toUpperCase();
            if (!roomCode) return showError("Please enter a room code.");
            if (!currentUserId) return showError("Not authenticated.");

            joinLobbyBtn.disabled = true;
            try {
                const lobbyRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies`, roomCode);
                const lobbySnap = await getDoc(lobbyRef);

                if (lobbySnap.exists()) {
                    currentLobbyId = roomCode;
                    
                    const playerRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies/${currentLobbyId}/players`, currentUserId);
                    const startX = Math.random() * 500 + 50;
                    const startY = Math.random() * 300 + 50;
                    
                    const newPlayer = {
                        ...playerSettings,
                        x: startX,
                        y: startY,
                        targetX: startX,
                        targetY: startY,
                        message: '',
                        messageTimestamp: 0,
                        isTyping: false,
                    };
                    players[currentUserId] = newPlayer;

                    await setDoc(playerRef, newPlayer);

                    switchToChatView();
                } else {
                    showError("Lobby not found.");
                }
            } catch (error) {
                console.error("Error joining lobby:", error);
                showError("An error occurred.");
            } finally {
                joinLobbyBtn.disabled = false;
            }
        }

        async function leaveLobby() {
            cancelAnimationFrame(animationFrameId);
            
            if (currentLobbyId && currentUserId) {
                const playerRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies/${currentLobbyId}/players`, currentUserId);
                await deleteDoc(playerRef);
            }

            if (unsubPlayers) unsubPlayers();
            
            players = {};
            currentLobbyId = null;
            
            switchToLobbyView();
        }
        
        async function handleCommand(commandText) {
            const args = commandText.match(/"[^"]+"|\S+/g) || [];
            const command = (args.shift() || '').toLowerCase();
            const values = args.map(arg => arg.replace(/"/g, ''));

            if (!command) return;
            
            if (command === '/help') {
                helpModal.classList.remove('hidden');
                return;
            }

            const playerRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies/${currentLobbyId}/players`, currentUserId);
            const updates = {};

            switch (command) {
                case '/user':
                    if (!values[0]) return showError("Usage: /user \"new name\"");
                    if (values[0].length > 20) return showError("Username must be 20 characters or less.");
                    updates.username = values[0];
                    break;

                case '/avatar':
                    if (!values[0]) return showError("Usage: /avatar \"text\" \"#hexcode\" (color optional)");
                    if (values[0].length > 3) return showError("Avatar text must be 3 characters or less.");
                    updates.avatar = values[0];
                    if (values[1]) {
                        if (!/^#[0-9a-fA-F]{6}$/.test(values[1])) return showError("Invalid hex color. Use #RRGGBB format.");
                        updates.avatarColor = values[1];
                    }
                    break;
                
                case '/avatarcolor':
                    if (!values[0] || !/^#[0-9a-fA-F]{6}$/.test(values[0])) return showError("Usage: /avatarcolor \"#RRGGBB\"");
                    updates.avatarColor = values[0];
                    break;
                
                case '/avatarangle':
                    if (!values[0]) return showError("Usage: /avatarangle \"degrees\"");
                    const angle = parseFloat(values[0]);
                    if (isNaN(angle)) return showError("Angle must be a number.");
                    updates.avatarAngle = angle;
                    break;

                case '/color':
                    if (!values[0] || !/^#[0-9a-fA-F]{6}$/.test(values[0])) return showError("Usage: /color \"#RRGGBB\"");
                    updates.color = values[0];
                    break;
                
                case '/shape':
                    const validShapes = ['circle', 'square', 'triangle'];
                    if (!values[0] || !validShapes.includes(values[0].toLowerCase())) return showError("Usage: /shape \"circle|square|triangle\"");
                    updates.shape = values[0].toLowerCase();
                    break;
                
                case '/cosmetic':
                    const validCosmetics = ['crown', 'tophat', 'cap', 'none'];
                    const cosmetic = values[0]?.toLowerCase();
                    if (!cosmetic || !validCosmetics.includes(cosmetic)) return showError("Usage: /cosmetic \"crown|tophat|cap|none\"");
                    updates.cosmetic = cosmetic === 'none' ? '' : cosmetic;
                    break;

                default:
                    return showError(`Unknown command: ${command}`);
            }

            if (Object.keys(updates).length > 0) {
                Object.assign(playerSettings, updates);
                savePlayerSettings();
                if(players[currentUserId]) {
                    Object.assign(players[currentUserId], updates);
                }
                await updateDoc(playerRef, updates);
            }
        }

        async function processInput() {
            const text = messageInput.value.trim();
            if (!text || !currentLobbyId || !currentUserId) return;
            
            messageInput.value = '';

            if (text.startsWith('/')) {
                handleCommand(text);
            } else {
                const now = Date.now();
                if (players[currentUserId]) {
                    players[currentUserId].message = text;
                    players[currentUserId].messageTimestamp = now;
                }
                const playerRef = doc(db, `artifacts/${app.options.projectId}/public/data/lobbies/${currentLobbyId}/players`, currentUserId);
                await updateDoc(playerRef, { message: text, messageTimestamp: now });
            }
        }

        function listenForPlayers() {
            if (unsubPlayers) unsubPlayers();
            const playersQuery = query(collection(db, `artifacts/${app.options.projectId}/public/data/lobbies/${currentLobbyId}/players`));
            
            unsubPlayers = onSnapshot(playersQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docData = change.doc.data();
                    const docId = change.doc.id;

                    if (change.type === "added") {
                        if (!players[docId]) {
                             players[docId] = {
                                ...docData,
                                targetX: docData.x,
                                targetY: docData.y
                            };
                        }
                    }
                    if (change.type === "modified") {
                        if (players[docId]) {
                            players[docId].targetX = docData.x;
                            players[docId].targetY = docData.y;
                            Object.assign(players[docId], docData);
                        }
                    }
                    if (change.type === "removed") {
                        delete players[docId];
                    }
                });
            });
        }

        // --- UI Switching and Helpers ---
        
        function loadPlayerSettings() {
            const savedSettings = JSON.parse(sessionStorage.getItem('playerSettings'));
            playerSettings = {
                username: 'Player',
                shape: 'circle',
                color: '#FFFFFF',
                avatar: '',
                avatarColor: '#FFFFFF',
                avatarAngle: 0,
                cosmetic: '',
                ...savedSettings
            };
        }

        function savePlayerSettings() {
            sessionStorage.setItem('playerSettings', JSON.stringify(playerSettings));
        }

        function updateCustomizationUI() {
            usernameEdit.value = playerSettings.username;
            shapeSelect.value = playerSettings.shape;
            colorPicker.value = playerSettings.color;
            cosmeticSelect.value = playerSettings.cosmetic;
            avatarText.value = playerSettings.avatar;
            avatarColorPicker.value = playerSettings.avatarColor;
            avatarAngle.value = playerSettings.avatarAngle;
            angleValue.textContent = playerSettings.avatarAngle;
        }

        function switchToChatView() {
            roomCodeDisplay.textContent = currentLobbyId;
            lobbyView.classList.add('hidden');
            chatView.classList.remove('hidden');
            chatView.classList.add('flex');
            
            resizeCanvas();
            listenForPlayers();
            requestAnimationFrame(gameLoop);
            messageInput.focus();
        }

        function switchToLobbyView() {
            chatView.classList.add('hidden');
            lobbyView.classList.remove('hidden');
            lobbyView.classList.add('flex');
            roomCodeInput.value = '';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 3000);
        }
        
        async function setTypingStatus(status) {
            isTyping = status;
            if (players[currentUserId]) {
                players[currentUserId].isTyping = status;
            }
            await updateSelfInFirestore({ isTyping: status });
        }

        // --- Event Listeners ---
        setUsernameBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                playerSettings.username = username;
                savePlayerSettings();
                startApp();
            }
        });
        usernameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') setUsernameBtn.click(); });

        createLobbyBtn.addEventListener('click', createLobby);
        joinLobbyBtn.addEventListener('click', () => joinLobby());
        leaveLobbyBtn.addEventListener('click', leaveLobby);
        messageInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter') {
                processInput();
                setTypingStatus(false);
            }
        });
        messageInput.addEventListener('focus', () => setTypingStatus(true));
        messageInput.addEventListener('blur', () => setTypingStatus(false));
        
        closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                helpModal.classList.add('hidden');
            }
            if (e.key in keys) {
                keys[e.key] = true;
            }
        });
        window.addEventListener('keyup', (e) => {
            if (e.key in keys) {
                keys[e.key] = false;
            }
        });
        
        roomCodeDisplay.addEventListener('click', () => {
             navigator.clipboard.writeText(roomCodeDisplay.textContent).then(() => {
                roomCodeDisplay.title = 'Copied!';
                setTimeout(() => { roomCodeDisplay.title = 'Click to copy'; }, 2000);
            });
        });

        // Customization Listeners
        usernameEdit.addEventListener('input', (e) => { 
            playerSettings.username = e.target.value;
            welcomeUsername.textContent = e.target.value;
            savePlayerSettings();
            drawPreview();
        });
        shapeSelect.addEventListener('change', (e) => { playerSettings.shape = e.target.value; savePlayerSettings(); drawPreview(); });
        colorPicker.addEventListener('input', (e) => { playerSettings.color = e.target.value; savePlayerSettings(); drawPreview(); });
        cosmeticSelect.addEventListener('change', (e) => { playerSettings.cosmetic = e.target.value; savePlayerSettings(); drawPreview(); });
        avatarText.addEventListener('input', (e) => { playerSettings.avatar = e.target.value.substring(0,3); savePlayerSettings(); drawPreview(); });
        avatarColorPicker.addEventListener('input', (e) => { playerSettings.avatarColor = e.target.value; savePlayerSettings(); drawPreview(); });
        avatarAngle.addEventListener('input', (e) => { 
            playerSettings.avatarAngle = e.target.value;
            angleValue.textContent = e.target.value;
            savePlayerSettings(); 
            drawPreview(); 
        });


        // --- Start the App ---
        loadAssets();
    </script>
</body>
</html>
